{% extends 'base.html' %}

{% block title %} Student Report {% endblock title %}


{% block content %}
<style>
.scrollable-table2 {
    max-height: 600px; /* Adjust this value based on your requirements */
    overflow-y: auto;
}

.sticky_head {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>

<!-- General Info-->
    <div class="card mt-3 " style="display: inline-block;">
        <div class="col text-center mt-1">
        <h6>{{ annual_report.school }}
            {{ annual_report.school_year }}
            {{ annual_report.report_type }}</h6>
        </div>
    </div>
<!-- Common registration date -->
    <div class="card mt-3">
        <div class="d-flex justify-content-left">
            <div class="row mt-1 mb-2 ml-2 ">
                <div class="col col-auto text-right">
                    <div class="text-left"><label for="common-registration-date"><b>Registration Date</b></label></div>
                    <div><input type="date" id="common-registration-date" style="width: 150px"/></div>
                </div>
                <div class="col col-auto text-left">
                    <div class="row">
                        <button class="btn btn-ISEIblue1 btn-sm mt-4 mr-2" id="add-date-button">Add Registration Date</button>
                    </div>
                </div>
                <div class="col col-auto text-left">
                    <div class="row">
                        <button class="btn btn-ISEIblue2 btn-sm mt-4 mr-2" id="rewrite-date-button">Rewrite Registration Date</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Comments and instructions -->
    <div class="card mt-2">
        <span class="ml-2">
           Depending on your screen size, in order to view all columns you may need to horizontally scroll through the table.
        </span>
    </div>

<!-- Student Report -->
    <div class="card">
        <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}
<!-- table with student data -->
            <div class="scrollable-table scrollable-table2">
                <table class="table table-light">
                    <thead class="thead-dark sticky_head">
                        <tr>
                            {% for field in formset.forms.0.visible_fields %}
                                <th>{{ field.label }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="formset">
                        {% for form in formset %}
                                <tr class="form">
                                    {% for field in form %}
                                        <td style="text-align: center;"> {{ field }}
                                         {% if field.errors %}
                                            <div class="text-danger">
                                                {{ field.errors }}
                                            </div>
                                        {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% if form.non_field_errors %}
                                <tr>
                                    <td colspan="{{ form|length }}">
                                        <div class="text-danger">
                                            {{ form.non_field_errors }}
                                        </div>
                                    </td>
                                </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
<!-- empty form template -->
            <template id="empty_form_template">
                <tr class="form">
                    {% for field in formset.empty_form %}
                        <td style="text-align: center;">{{ field }}</td>
                    {% endfor %}
                </tr>
             </template>

<!--buttons-->
            <div class="row mb-2 mt-2">
                <div class="col d-flex justify-content-center">
                    <button class="btn btn-sm btn-ISEIblue4" type="button" id="add_more">Add More Students</button></div>
                <div class="col d-flex justify-content-center">
                    <input class="btn btn-sm btn-ISEIblue2"  type="submit" name="save"  value="Save and Finalize Later"></div>
                <div class="col d-flex justify-content-center">
                    <input class="btn btn-sm btn-success" type="submit" name="submit"  value="Report Complete"></div>
                <div class="col d-flex justify-content-center">
                    <a class="btn btn-sm btn-danger" href="{% url 'principal_dashboard' request.user.id %}" onclick="return confirm('Any changes made will not be saved. Do you want to continue?');">Return</a></div>
            </div>
        </form>
    </div>

    <div class="card">
        <span class="spanred ml-2">
            If there are blank student records that don't allow submission, select the Delete checkbox next to them (at the very end of the table) before attempting to Save or Submit the report.
        </span>
    </div>


    <script>

        // To make TN_county available only for TN schools, and add USA as country if US state is selected
    $(document).ready(function() {
    // Listen to any change on state fields
        $(document).on('change', 'select[name$=us_state]', function() {
        // Get the TN county field in the same form
            var tn_county_field = $(this).closest('tr').find('select[name$=TN_county]');
        // Get the Country select field in the same form
            var country_field = $(this).closest('tr').find('select[name$=country]');

            if ( country_field.val()!==4 && $(this).val()) {  // if any value (not empty) is selected for US state
                country_field.val(4);  // set the country field to USA
                country_field.on('mousedown keydown', function(e) {
                e.preventDefault();}); // Prevent mouse and keyboard interactions
            }

            if ( !$(this).val()) {
                country_field.off('mousedown keydown');  // Restore mouse and keyboard interactions
            }

            if ($(this).val() === 'TN') {
                tn_county_field.prop('disabled', false);
            } else {
                tn_county_field.prop('disabled', true);
                tn_county_field.val(''); // You might also want to reset the county select box
            }
        });

        // Initialize the TN county field state on page load
        $('select[name$=us_state]').each(function () {
            $(this).trigger('change');
        });
    });

    var addMore = document.getElementById('add_more');
    var formset = document.getElementById('formset');
    var emptyFormTemplate = document.getElementById('empty_form_template');
    var totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');

//add new Student Form on button click
    addMore.addEventListener('click', function() {
        var newIndex = formset.getElementsByClassName('form').length;
        var newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, newIndex);

        // Create new form DOM Element
        var newForm = document.createElement('tr');
        newForm.className = 'form';
        newForm.innerHTML = newFormHtml;

        // Append to the formset
        formset.appendChild(newForm);

        // Increase the value of TOTAL_FORMS.
        totalForms.value = parseInt(totalForms.value) + 1;
    });

//add common registration date for existing records with no registration date
    document.getElementById('add-date-button').addEventListener('click', function(e) {
        e.preventDefault();  // prevent form submission if the button type is 'submit'
        var commonDate = document.getElementById('common-registration-date').value;
        var registrationDateInputs = document.querySelectorAll('input[name$="registration_date"]');
        registrationDateInputs.forEach(function(input) {
            if(input.value === '') {
                input.value = commonDate;
            }
        });
    });

//Confirmation message for adding common registration to existing records
    document.getElementById("add-date-button").onclick = function() {
        return confirm('This date is added only to records with blank registration date. Ensure that you are applying the correct date!');
    }

//rewrite common registration date for ALL existing records
    document.getElementById('rewrite-date-button').addEventListener('click', function(e) {
        e.preventDefault();  // prevent form submission if the button type is 'submit'
        var commonDate = document.getElementById('common-registration-date').value;
        var registrationDateInputs = document.querySelectorAll('input[name$="registration_date"]');
        registrationDateInputs.forEach(function(input) {
            input.value = commonDate;
        });
    });

//Confirmation message for rewriting registration date to existing records
    document.getElementById("rewrite-date-button").onclick = function() {
        return confirm(
            'This date will change ALL registration dates to date entered. Are you sure you want to do this?');
    }

// add common registration date when student name is entered
    $(document).on('change', 'input[name^="form-"][name$="-name"]', function() {
        var commonDate = document.getElementById('common-registration-date').value;
        var registrationDateInput = $(this).closest('tr').find('input[name$="registration_date"]');
        if (registrationDateInput.length > 0 && registrationDateInput.val() === '') {
            registrationDateInput.val(commonDate);
        }
    });

//Confirmation message for adding common registration to existing records
    document.getElementById("update-button").onclick = function() {
        return confirm('This date is added only to records with blank registration date. Ensure that you are applying the correct date!');
    }
    </script>

{% endblock %}