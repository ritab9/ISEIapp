{% extends 'reporting_base.html' %}
{% load crispy_forms_tags %}

{% block title %} 190-Day Report {% endblock title %}


{% block content %}

    <div class="">
         <div class="row ml-2">
            <h6>{{ annual_report }}</h6>
        </div>

        <form method="post" id="my_form">
        {% csrf_token %}

 <!-- Day190 form -->
            <div class="card card-body">

                <div class="row justify-content-around">
                    <div class="col-auto">

                            <table class="table table-sm" style="width: 100%">
                                <tr>
                                    <td style="width: 1px; white-space: nowrap;"> <b>{{ form.start_date.label_tag }}</b>
                                        <br>*First day students are present</td>
                                    <td>{{ form.start_date }}{{ form.start_date.errors }}</td>
                                </tr>
                                <tr>
                                    <td style="width: 1px; white-space: nowrap;"><b>{{ form.end_date.label_tag }}</b>
                                        <br>*Last school day or graduation day</td>
                                    <td> {{ form.end_date }}{{ form.end_date.errors }}</td>
                                </tr>

                              <tr>
                                <td style="width: 1px; white-space: nowrap;">No. of weekdays (in school year):</td>
                                <td style="text-align:left">
                                <input class="number_input" type="text" id="number_of_weekdays" readonly style="border: none"> </td>
                              </tr>
                            <tr>
                                <td class="" style="width: 1px; white-space: nowrap; ">{{ form.number_of_sundays.errors }}
                                    <b>{{ form.number_of_sundays.label_tag }}</b></td>
                                <td>{{ form.number_of_sundays }}
                                <i tabindex="0" class="fas fa-info-circle" role="button" data-bs-toggle="popover" data-trigger="focus" data-bs-placement="right" data-bs-content="Work on this"></i>
                            </table>
                    </div>

                    <div class="col-auto">
                            <table class="table table-sm mt-3 mb-3">

                                <tr>
                                    <td class="" style="width: 1px; white-space: nowrap;">{{ form.inservice_days.errors }}
                                        <b>In-service and Discretionary days:</b>
                                    </td>
                                    <td>{{ form.inservice_days }}</td>
                                </tr>

                                <tr><td colspan="4" id="10_day_message" class="error"></td></tr>
                                <tr><td colspan="2" class="error" id="inservice_day_message"></td></tr>

                            </table>
                            <button id="toggleButton" type="button" class="btn btn-xs btn-outline-ISEIblue4">In-service and Discretionary Days Info</button>

                    </div>

                    <div class="col-auto">
                             <table class="table-sm table-bordered">
                                <tr>
                                    <td style="width: 1px; white-space: nowrap; ">
                                      {{ form.number_of_days.errors }}
                                      <b>{{ form.number_of_days.label_tag }}</b>
                                    </td>
                                    <td style = "text-align-last: left; border:none">{{ form.number_of_days }}</td>

                                    <td style="width: 1px; white-space: nowrap;"><b>Total Days</b></td>
                                    <td style ="text-align: left"><input class="number_input" type="text" id="total_days" readonly style="border: none"></td>
                                </tr>

                                <tr>
                                    <td colspan="2">*Minimum 180 instructional days</td>
                                    <td colspan="2">*Minimum 190 days</td>
                                </tr>
                                <tr><td colspan="4" id="no_of_days_message"></td></tr>

                            </table>
                    </div>

                </div>
            </div>


            <div class="card card-body">
                <div class="row justify-content-around">
<!-- Vacations formset -->
                    <div class="col-auto">
                            <h6>Vacations</h6>
                        <div id="vacation-formset">
                            {{ formset_vacation.management_form }}
                            <table class="table-sm" style="table-layout:auto ">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Weekdays</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for form in formset_vacation %}
                                    {{ form.id }}
                                    <tr class="individual-form">
                                        <td>{{ form.name }}<span class="error">{{ form.name.errors }}</span></td>
                                        <td>{{ form.start_date }}<span class="error">{{ form.start_date.errors }}</span></td>
                                        <td>{{ form.end_date }}<span class="error">{{ form.end_date.errors }}</span></td>
                                        <td>{{ form.weekdays }}<span class="error">{{ form.weekdays.errors }}</span></td>
                                    </tr>
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                </tbody>
                            </table>
                            <table class="table"><tr><td>
                                        <button type="button" class="btn-ISEIblue4 add-form-button" id="vacation">Add rows</button>
                                        </td>
                                        <td colspan="2" class="text-right"> No. of vacation weekdays: <input class="number_input text-left" type="text" id="total_vacation_days" readonly style="border: none"></td>

                                    </tr>
                            </table>
                        </div>

                        <div style="text-align: right" class="mr-5">
                        </div>

                    </div>

<!-- InserviceDiscretionaryDays formset -->
                    <div class="col-auto">
                        <h6>In-service and Discretionary Days</h6>

                        <div id="inservice-formset">
                            {{ formset_inservice.management_form }}
                            <table class="table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Dates</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>

                                <tbody>
                                {% for form in formset_inservice %}
                                    {{ form.id }}
                                    <tr class="individual-form">
                                        <td>{{ form.type }}<span class="error">{{ form.type.errors }}</span></td>
                                        <td>{{ form.dates }}<span class="error">{{ form.dates.errors }}</span></td>
                                        <td>{{ form.hours }}<span class="error">{{ form.hours.errors }}</span></td>
                                    </tr>
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                </tbody>
                            </table>
                            <table class="table">
                                    <tr><td colspan="3" class="text-left"><button type="button" class="btn-ISEIblue4 add-form-button" id="inservice">Add rows</button></td>
                                    </tr>
                                    <tr>
                                        <td>Total: <input class="number_input" type="text" id="total_inservice_discretionary_hours" readonly style="border: none"></td>
                                        <td>Discretionary: <input class="number_input" type="text" id="total_discretionary_hours" readonly style="border: none"></td>
                                        <td>Inservice: <input class="number_input" type="text" id="total_inservice_hours" readonly style="border: none"></td>
                                    </tr>
                                    <tr><td colspan="3" class="error" id="30_hr_message"></td></tr>
                            </table>
                        </div>


                    </div>

<!-- AbbreviatedDays formset -->

                    <div class="col-auto">
                        <h6>Abbreviated Days</h6>

                        <div id="abbreviated-formset">
                            {{ formset_abbreviated.management_form }}
                            <table class="table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for form in formset_abbreviated %}
                                    {{ form.id }}
                                    <tr class="individual-form">
                                        <td>{{ form.date }}<span class="error">{{ form.date.errors }}</span></td>
                                        <td>{{ form.hours }}<span class="error">{{ form.hours.errors }}</span></td>
                                    </tr>
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                </tbody>
                            </table>
                        </div>
                        <table class="table">
                            <tr><td>
                                    <button type="button" class="btn-ISEIblue4 add-form-button" id="abbreviated">Add rows</button>
                                </td>

                            </tr>
                            <tr><td>*days less than 6.5 hrs and more than 3.5 hrs <br>
                                    (no more than three per school-year)</td>
                            </tr>
                        </table>

                    </div>
                </div>
            </div>

            <!-- empty templates -->
            <div>
                <template id="empty_vacation_form_template">
                    <tr class="individual-form">
                        <td>
                            {{ formset_vacation.empty_form.name }}
                            <span class="error">{{ formset_vacation.empty_form.name.errors }}</span>
                        </td>
                        <td>
                            {{ formset_vacation.empty_form.start_date }}
                            <span class="error">{{ formset_vacation.empty_form.start_date.errors }}</span>
                        </td>
                        <td>
                            {{ formset_vacation.empty_form.end_date }}
                            <span class="error">{{ formset_vacation.empty_form.end_date.errors }}</span>
                        </td>
                        <td>
                            {{ formset_vacation.empty_form.weekdays }}
                            <span class="error">{{ formset_vacation.empty_form.weekdays.errors }}</span>
                        </td>
                    </tr>
                    {% if formset_vacation.empty_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ formset_vacation.empty_form.non_field_errors }}
                        </div>
                    {% endif %}
                </template>


                <template id="empty_inservice_form_template">
                    <tr class="individual-form">
                        <td>
                            {{ formset_inservice.empty_form.type }}
                            <span class="error">{{ formset_inservice.empty_form.type.errors }}</span>
                        </td>
                        <td>
                            {{ formset_inservice.empty_form.dates }}
                            <span class="error">{{ formset_inservice.empty_form.dates.errors }}</span>
                        </td>
                        <td>
                            {{ formset_inservice.empty_form.hours }}
                            <span class="error">{{ formset_inservice.empty_form.hours.errors }}</span>
                        </td>
                    </tr>
                    {% if formset_inservice.empty_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ formset_inservice.empty_form.non_field_errors }}
                        </div>
                    {% endif %}
                </template>

                <template id="empty_abbreviated_form_template">
                    <tr class="individual-form">
                        <td>
                            {{ formset_abbreviated.empty_form.date }}
                            <span class="error">{{ formset_abbreviated.empty_form.date.errors }}</span>
                        </td>
                        <td>
                            {{ formset_abbreviated.empty_form.hours }}
                            <span class="error">{{ formset_abbreviated.empty_form.hours.errors }}</span>
                        </td>
                    </tr>
                    {% if formset_abbreviated.empty_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ formset_abbreviated.empty_form.non_field_errors }}
                        </div>
                    {% endif %}
                </template>
            </div>



            <div class="row mt-2">
                  <div class="col d-flex justify-content-center">
                    <button class="btn btn-sm btn-ISEIblue2" type="submit" name="save">Save and Finalize Later</button>
                  </div>
                  <div class="col d-flex justify-content-center">
                        <button class="btn btn-sm btn-success" type="submit" name="submit">Report Complete</button>
                  </div>
                  <div class="col d-flex justify-content-center">
                    <a class="btn btn-sm btn-danger" href="{% url 'school_dashboard' annual_report.school.id %}" onclick="return confirm('Any changes made will not be saved. Do you want to continue?');">Exit without saving</a>
                  </div>
            </div>

            <div class="row d-flex justify-content-center">
                <div class="" id="enough_days" style="display: none;">
                      <span class="error"> Some requirements are not met!</span> <br>
                      Please check the messages in <span class="error">red</span> before submission.
                </div>
            </div>

        </form>

            <div class="card">
                <div id="inservice_discretionary_info" style="display:none;">
                    {% include 'inservice_discretionary_info.html' with discretionary_div=True %}
                </div>
            </div>


    </div>





<script>
//add new forms in the formset
    $(document).ready(function(){
        $(".add-form-button").click(function(){
            var buttonId = $(this).attr("id");

            if (buttonId === "abbreviated") {
                var countForms = $(`#${buttonId}-formset table tbody .individual-form`).length;
                if (countForms >= 3) {
                    alert('There can be a maximum of 3 abbreviated days');
                    return;  // Prevent the rest of the function from executing
                }
            }

            // target formset inside the tbody
            var formset = document.querySelector(`#${buttonId}-formset table tbody`);

            var emptyFormTemplate = document.getElementById("empty_" + buttonId + "_form_template");
            var totalForms = document.querySelector(`input[name="${buttonId}-TOTAL_FORMS"]`);

            var newIndex = formset.getElementsByClassName("individual-form").length;
            var newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, newIndex);

            // Create new form DOM Element
            var newForm = document.createElement("tr");
            newForm.className = "individual-form";
            newForm.innerHTML = newFormHtml;

            // Append to the formset
            formset.appendChild(newForm);

            // Increase the value of TOTAL_FORMS.
            totalForms.value = parseInt(totalForms.value) + 1;
        });
    });

//calculate no of weekdays between two dates
    function countWeekdays(startDate, endDate) {
    var weekdays = 0;
    var currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        // 0: Sunday, 6: Saturday
        if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
            weekdays++;
        }
        currentDate.setDate(currentDate.getDate() + 1)
    }
    return weekdays;
  }

  // Function to calculate total vacation weekdays
    function calculateTotalVacationDays() {
        var totalVacationDays = 0;
        var numberOfVacations = parseInt($("#id_vacation-TOTAL_FORMS").val());

        for (var i = 0; i < numberOfVacations; i++) {
            var weekdaysInput = $('#id_vacation-' + i + '-weekdays');
            if (weekdaysInput.length > 0 && weekdaysInput.val() !== '') {  // Check if the input element exists and has a value
                totalVacationDays += parseInt(weekdaysInput.val());
            }
        }

        $('#total_vacation_days').val(totalVacationDays);
    }

//calculate and set no of weekdays in a vacation
    $(document).on('blur', 'input[id^="id_vacation-"][id$="-start_date"], input[id^="id_vacation-"][id$="-end_date"]', function(){
        var formIndex = $(this).attr('id').split('-')[1];
        var start = $('#id_vacation-' + formIndex + '-start_date').val();
        var end = $('#id_vacation-' + formIndex + '-end_date').val();

        if (start && end) {
            var startDate = new Date(start);
            var endDate = new Date(end);
            var totalWeekdays = countWeekdays(startDate, endDate);
            $('#id_vacation-' + formIndex + '-weekdays').val(totalWeekdays);
            calculateTotalVacationDays(); // Also update the total vacation days
            updateNumberOfDays(); // Update number_of_days after the change
        }
    });


  //calculate and set no of weekdays between school begining and end date
    $(document).ready(function() {
        var calculateDays = function() {
            var start = $('#id_start_date').val();
            var end = $('#id_end_date').val();

            if (start && end) {
                var startDate = new Date(start);
                var endDate = new Date(end);
                var totalWeekdays = countWeekdays(startDate, endDate);
                $('#number_of_weekdays').val(totalWeekdays);
            }
        };

        calculateTotalVacationDays();


        $('#id_start_date, #id_end_date').each(function () {
            // If the inputs have values already, calculate the days
            if ($(this).val()) {
                calculateDays();
                updateNumberOfDays();
            }
        });

        $(document).on('blur', '#id_start_date, #id_end_date', function() {
            calculateDays();
            updateNumberOfDays(); // Update number_of_days after the change
        });
    });


// general message if there aren't enough school days, i and d days, or inservice hours planned
    var enough_school_days = true
    var enough_i_d_days = true
    var enough_i_hours = true

    function enough_days() {
            if (!enough_school_days || !enough_i_d_days || !enough_i_hours) {
                $('#enough_days').show();
            } else {
                $('#enough_days').hide();
            }
        }

    $(document).ready(function() {
        // Call the function initially to set the initial visibility
        enough_days();
    });


//update number of school days and total days
    function updateNumberOfDays() {
        const totalVacationDays = parseInt($('#total_vacation_days').val()) || 0;
        const numberOfWeekdays = parseInt($('#number_of_weekdays').val()) || 0;
        const numberOfSundays = parseInt($('#id_number_of_sundays').val()) || 0;
        const numberOfDays = numberOfWeekdays - totalVacationDays + numberOfSundays;

        if (numberOfDays < 180) {
            $('#id_number_of_days').removeClass('text-success'); // removes the green and yellow colors
            $('#id_number_of_days').addClass('text-danger'); // adds the red color
            $('#no_of_days_message').text('Number of school days is too low!').addClass('text-danger'); // changes the text content of the specific td
            enough_school_days = false; enough_days();
        } else if (numberOfDays > 220) {
            $('#id_number_of_days').removeClass('text-success'); // removes the green and red colors
            $('#id_number_of_days').addClass('text-danger'); // adds the yellow color
            $('#no_of_days_message').text('That seems like too many days! Did you enter vacations?').addClass('text-danger'); // changes the text content of the specific td
            enough_school_days = true; enough_days();
        } else {
            $('#id_number_of_days').removeClass('text-danger'); // removes the red and yellow colors
            $('#id_number_of_days').addClass('text-success'); // adds the green color
            $('#no_of_days_message').text(''); // changes the text content of the specific td
            enough_school_days = true; enough_days();
        }

        $('#id_number_of_days').val(numberOfDays);
         var inserviceDays = parseInt($('#id_inservice_days').val()) || 0;
         var totalDays = numberOfDays + inserviceDays;

         if (totalDays < 190) {
            $('#total_days').removeClass('text-success'); // removes the green color
            $('#total_days').addClass('text-danger'); // adds the red color
        } else {
            $('#total_days').removeClass('text-danger'); // removes the red color
            $('#total_days').addClass('text-success'); // adds the green color
        }

         $('#total_days').val(totalDays);
      }

     // Calculate the number of days and set the value every time when days count or dates could be changed:
    $(document).on('change', '#id_number_of_sundays',updateNumberOfDays);
    $(document).on('change', '#id_inservice_days', updateNumberOfDays);



//inservice and discretionary day calculations

    $(document).ready(function() {
        function calcTotal() {
            var discretionary = 0;
            var inservice = 0;
            var total = 0;

            var inserviceDays = parseFloat($("#id_inservice_days").val());
            if (isNaN(inserviceDays) || inserviceDays == "") { inserviceDays = 0; }

            if (inserviceDays< 10) {
                 $('#10_day_message').html("There must be a minimum of 10 days.<br> Up to five might be discretionary.")
                enough_i_d_days = false; enough_days();
            }else{
                $('#10_day_message').html("");
                enough_i_d_days = true; enough_days();
            }

            var minCalcHours = inserviceDays * 6 - 2;
            var maxCalcHours = inserviceDays * 8;

            $('input[id^="id_inservice-"][id$="-hours"]').each(function () {
                var val = parseFloat($(this).val());
                if (isNaN(val) || val.length === 0) {
                    val = 0;
                }
                var type = $(this).closest('tr').find('select[id^="id_inservice-"][id$="-type"]').val();
                if (type === 'DS') {
                    discretionary += val;
                } else {
                    inservice += val;
                }

                total += val;
            });

            if (inservice < 30) {
                $('#total_inservice_hours').addClass('text-danger');
                $('#30_hr_message').html("There must be a minimum of 30 in-service hours");
                enough_i_hours = false; enough_days();
            } else {
                $('#total_inservice_hours').removeClass('text-danger');
                 $('#30_hr_message').html("");
                 enough_i_hours = true; enough_days();
            }

            // Checks for at least 30 inservice hours
            if (total < minCalcHours || total > maxCalcHours) {
                 $('#inservice_day_message').html("<ul>" +
                  " <li>No. of days (above) and no. of hours (below) don't seem to match.</li>" +
                   "<li>6-8 hours would count as a day</li>"+
                   "<li>Did you enter planned activities below?</li>");
            } else {
                $('#inservice_day_message').html("");
            }


            // Update the values
            $('#total_discretionary_hours').val(discretionary+' hrs');
            $('#total_inservice_hours').val(inservice+' hrs');
            $('#total_inservice_discretionary_hours').val(total+' hrs');

        }

        // Calculate totals on load
        calcTotal();

        // Calculate totals whenever the hours or type changes on any row
        $('input[id^="id_inservice-"][id$="-hours"], select[id^="id_inservice-"][id$="-type"], #id_inservice_days').change(function () {
            calcTotal();
        });
    });

// toggle Info box
      $(document).ready(function(){
        $("#toggleButton").click(function(){
            $("#inservice_discretionary_info").toggle();  // This will hide and show the div with id myContent
        });
    });

//Popover
      document.addEventListener("DOMContentLoaded", function(){
          var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
          var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
          })
        });

</script>

{% endblock %}