<!-- apr_progress_reportB-->
{% extends 'accreditation_base.html' %}

{% block title %} APR Progress {% endblock title %}


{% block content %}

<div class="container">
    <div class="card card-body">

        <h6 class="text-center mt-2">Progress Overview for {{ apr }}</h6>

        <b>Instructions:</b>
        The APR is to be completed annually describing the progress made on the directives and action plans from the last Accreditation Visit.
        <br> Please also choose the appropriate progress descriptor:
            <ul>
              <li><b>Not Started</b>: Indicates there has been no activity on this directive.</li>
              <li><b>In Progress</b>: Give a brief description of the progress made in the comment box.</li>
              <li><b>Completed/Ongoing</b>: Give a brief description explaining how the directive was completed or how it will continue.</li>
            </ul>
    </div>

    <!-- Action Plan Directives -->

    {% if action_plan_directives %}
    <div x-data="{ showContent: true }">
    <!-- Section Title -->
        <h6 class="text-left mt-2 mb-1" @click="showContent = !showContent" style="cursor: pointer;">
            Action Plan Directives
            <span x-text="showContent ? '▼' : '▲'" class="ml-2"></span>
        </h6>
        {% for directive in action_plan_directives %}
            <div x-show="showContent" class="card card-body">
              <div id="directive-{{ directive.id }}">
                <p><b>Action Plan Directive {{ directive.number }}. </b>{{ directive.description }}</p>
                <form>
                  <label for="completed_date_{{ directive.id }}">Completed Date:</label>
                  <input type="date" id="completed_date_{{ directive.id }}" value="{{ directive.completed_date|date:'Y-m-d' }}" class="completed-date-input" data-id="{{ directive.id }}">
                </form>
              </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if priority_directives_progress %}
        {% include 'apr/progress_section.html' with section_title='Priority Directive' directives_progress=priority_directives_progress %}
    {% endif %}

    {% if directives_progress %}
        {% include 'apr/progress_section.html' with section_title='Directive' directives_progress=directives_progress %}
    {% endif %}

    {% if recommendations_progress %}
        {% include 'apr/progress_section.html' with section_title='Recommendation' directives_progress=recommendations_progress %}
    {% endif %}

    {% if action_plans_progress %}
        {% include 'apr/progress_section.html' with section_title='Action Plan' directives_progress=action_plans_progress %}
    {% endif %}

</div>

{% endblock %}


{% block footer_javascript %}

<script>

//update yearly  Progress
    function saveProgress(progressId, newDescription) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/update_progress/${progressId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ description: newDescription }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to save progress');
            }
            return response.json();
        })
        .then(data => {
            if (data.description !== newDescription) {
                alert('Failed to update progress on the server.');
                console.error('Mismatch between server response and updated data.');
            } else {
                //alert('Progress saved successfully!');
                this.originalDescription = newDescription; // Update originalDescription with the new description
                // Successfully saved progress, close editing window and restore DOM
            }
        })
        .catch(error => {
            console.error('Error saving progress:', error);
            alert('An error occurred while saving progress. Please try again.');
        });
    }

//update progress Status
    function updateProgressStatus(directive_id) {

            // Get the selected value from the dropdown
            const progressStatus = document.getElementById(`progress_status_${directive_id}`).value;

            // Send the update to the server using AJAX
            fetch("{% url 'update_progress_status' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value // CSRF token for security
                },
                body: JSON.stringify({
                    directive_id: directive_id,
                    progress_status: progressStatus
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Progress status updated successfully!');
                } else {
                    alert('Failed to update progress status.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred.');
            });
        }

//Update Action Plan Directive submission date
    document.addEventListener('DOMContentLoaded', function () {
        const dateInputs = document.querySelectorAll('.completed-date-input');

        dateInputs.forEach(input => {
          input.addEventListener('change', function () {
            const directiveId = this.getAttribute('data-id');
            const completedDate = this.value;

            fetch('{% url "update_actionplandirective_completed_date" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({
                id: directiveId,
                completed_date: completedDate
              })
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              }
              throw new Error('Network response was not ok');
            })
            .then(data => {
              alert(data.message);
            })
            .catch(error => {
              console.error('There was a problem with the fetch operation:', error);
            });
          });
        });
      });

</script>

{% endblock %}


